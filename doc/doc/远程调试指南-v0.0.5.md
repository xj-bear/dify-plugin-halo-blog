# Halo CMS Dify Plugin 远程调试指南 - v0.0.5

## 🎯 远程调试概述

远程调试允许我们在本地开发环境中运行插件，同时连接到 cloud.dify.ai 进行实时测试和调试。

## 🔧 环境配置

### 1. 安装依赖
```bash
pip install -r requirements.txt
```

### 2. 配置远程调试密钥
创建 `key.txt` 文件（不要提交到Git）：
```
your-remote-debug-key-here
```

### 3. 环境变量配置
创建 `.env` 文件（不要提交到Git）：
```env
DIFY_REMOTE_DEBUG_KEY=your-remote-debug-key-here
HALO_BASE_URL=https://your-halo-site.com
HALO_ACCESS_TOKEN=your-access-token
```

## 🚀 启动远程调试

### 方法1：直接启动
```bash
python -m main
```

### 方法2：使用调试脚本
```bash
python start_remote_debug.py
```

### 方法3：使用远程调试模块
```bash
python remote_debug.py
```

## 📊 调试流程

### 1. 启动调试服务
```
2025-07-01 16:42:56,075 - __main__ - INFO - Starting Halo Blog Tools plugin...
2025-07-01 16:42:56,076 - __main__ - INFO - Plugin starting with install method: remote
2025-07-01 16:42:56,077 - __main__ - INFO - Remote key configured: ****************************dee8449f
2025-07-01 16:42:56,915 - dify_plugin.core.server.tcp.request_reader - INFO - Connected to debug.dify.ai:5003
2025-07-01 16:42:56,928 - dify_plugin.plugin - INFO - Installed tool: halo-blog-tools
2025-07-01 16:42:56,929 - dify_plugin.core.server.tcp.request_reader - INFO - Sent key to debug.dify.ai:5003
2025-07-01 16:42:56,932 - __main__ - INFO - Halo Blog Tools plugin initialized successfully
```

### 2. 在 cloud.dify.ai 中测试
- 打开 cloud.dify.ai
- 进入应用设置
- 添加自定义插件
- 使用远程调试密钥连接

### 3. 实时查看日志
本地终端会显示所有API调用和响应：
```
2025-07-01 16:45:27,156 - tools.halo-post-create - INFO - Trying endpoint /apis/api.console.halo.run/v1alpha1/users/-: status 200
2025-07-01 16:45:27,215 - tools.halo-post-create - INFO - Create post response status: 201
2025-07-01 16:45:27,215 - tools.halo-post-create - INFO - Create post response body: {"spec":{"title":"测试15"...
```

## 🔍 调试技巧

### 1. 详细日志记录
```python
import logging
logger = logging.getLogger(__name__)

# 记录请求数据
logger.info(f"Creating post with data: {json.dumps(post_data, indent=2, ensure_ascii=False)}")

# 记录响应信息
logger.info(f"Response status: {response.status_code}")
logger.info(f"Response headers: {dict(response.headers)}")
logger.info(f"Response body: {response.text}")
```

### 2. 错误处理和调试
```python
try:
    response = session.post(url, json=data, timeout=30)
    logger.info(f"Request successful: {response.status_code}")
except requests.exceptions.RequestException as e:
    logger.error(f"Request failed: {str(e)}")
    yield self.create_text_message(f"❌ 请求失败: {str(e)}")
    return
```

### 3. 分步调试
```python
# 步骤1：测试连接
yield self.create_text_message("🔗 正在测试连接...")

# 步骤2：验证权限
yield self.create_text_message("🔐 正在验证权限...")

# 步骤3：执行操作
yield self.create_text_message("📝 正在创建文章...")
```

## 🐛 常见问题

### 1. 连接失败
**问题**：无法连接到 debug.dify.ai
**解决**：
- 检查网络连接
- 验证调试密钥是否正确
- 确认防火墙设置

### 2. 权限错误
**问题**：403 Forbidden 错误
**解决**：
- 检查 Halo 访问令牌
- 验证令牌权限范围
- 确认 Halo 版本兼容性

### 3. 超时问题
**问题**：请求超时
**解决**：
```python
# 增加超时时间
response = session.get(url, timeout=60)

# 添加重试机制
for attempt in range(3):
    try:
        response = session.get(url, timeout=30)
        break
    except requests.exceptions.Timeout:
        if attempt == 2:
            raise
        time.sleep(1)
```

## 📈 性能监控

### 1. 请求时间监控
```python
import time

start_time = time.time()
response = session.post(url, json=data)
end_time = time.time()

logger.info(f"Request took {end_time - start_time:.2f} seconds")
```

### 2. 内存使用监控
```python
import psutil
import os

process = psutil.Process(os.getpid())
memory_info = process.memory_info()
logger.info(f"Memory usage: {memory_info.rss / 1024 / 1024:.2f} MB")
```

## 🔄 版本更新流程

### 1. 修改代码
- 修复bug或添加功能
- 更新版本号

### 2. 重启调试服务
```bash
# 停止当前服务 (Ctrl+C)
# 重新启动
python -m main
```

### 3. 在 cloud.dify.ai 中测试
- 新功能会自动生效
- 无需重新配置插件

## 📝 调试日志分析

### 成功的请求日志
```
INFO - Trying endpoint /apis/api.console.halo.run/v1alpha1/users/-: status 200
INFO - Successfully got username: jason
INFO - Create post response status: 201
INFO - Parsed response successfully, post_name: 489e4f0a-ba15-4c80-b341-c81918cecca2
```

### 失败的请求日志
```
WARNING - 内容更新出错: cannot access local variable 'datetime' where it is not associated with a value
ERROR - Request failed: HTTPSConnectionPool(host='blog.u2u.fun', port=443)
```

## 🎯 最佳实践

1. **保持日志详细但不冗余**
2. **使用有意义的错误消息**
3. **及时清理调试代码**
4. **定期备份调试配置**
5. **记录重要的调试发现**
