# Halo CMS Dify Plugin 快速修复命令

## 🚀 常用修复命令

### 1. 重启远程调试
```bash
# 停止当前进程 (Ctrl+C)
# 重新启动
python -m main
```

### 2. 清理缓存文件
```bash
# Windows PowerShell
Get-ChildItem -Recurse -Directory -Name "__pycache__" | ForEach-Object { Remove-Item -Recurse -Force $_ }

# Linux/macOS
find . -type d -name "__pycache__" -exec rm -rf {} +
```

### 3. 重新安装依赖
```bash
pip uninstall -r requirements.txt -y
pip install -r requirements.txt
```

### 4. 检查文件权限
```bash
# Linux/macOS
chmod +x main.py
chmod -R 755 tools/
chmod -R 755 provider/
```

### 5. 验证配置文件
```bash
# 检查 manifest.yaml 语法
python -c "import yaml; yaml.safe_load(open('manifest.yaml'))"

# 检查 requirements.txt
pip check
```

## 🔧 调试命令

### 1. 测试单个工具
```python
# 在 Python 中测试
from tools.halo_setup import HaloSetupTool
tool = HaloSetupTool()
# 手动调用测试
```

### 2. 检查网络连接
```bash
# 测试 Halo CMS 连接
curl -I https://your-halo-site.com

# 测试 Dify 调试服务
telnet debug.dify.ai 5003
```

### 3. 查看详细日志
```python
import logging
logging.basicConfig(level=logging.DEBUG)
```

## 🐛 常见问题快速修复

### 1. 导入错误
```bash
# 重新生成 __init__.py
echo "# Halo Blog Tools" > tools/__init__.py
echo "# Halo Blog Tools Provider" > provider/__init__.py
```

### 2. 版本冲突
```bash
# 创建虚拟环境
python -m venv venv
source venv/bin/activate  # Linux/macOS
# 或
venv\Scripts\activate     # Windows

pip install -r requirements.txt
```

### 3. 编码问题
```python
# 在文件开头添加
# -*- coding: utf-8 -*-
```

### 4. 权限问题
```python
# 检查访问令牌
import requests
headers = {"Authorization": "Bearer your-token"}
response = requests.get("https://your-halo-site.com/apis/api.console.halo.run/v1alpha1/users/-", headers=headers)
print(response.status_code, response.text)
```

## 📊 性能优化命令

### 1. 内存使用检查
```python
import psutil
import os
process = psutil.Process(os.getpid())
print(f"Memory: {process.memory_info().rss / 1024 / 1024:.2f} MB")
```

### 2. 请求时间监控
```python
import time
start = time.time()
# 执行请求
end = time.time()
print(f"Request took: {end - start:.2f}s")
```

### 3. 连接池优化
```python
import requests
session = requests.Session()
session.mount('https://', requests.adapters.HTTPAdapter(pool_connections=10, pool_maxsize=20))
```

## 🔄 版本更新命令

### 1. 更新版本号
```bash
# 使用 sed 批量更新 (Linux/macOS)
sed -i 's/version: 0.0.1/version: 0.0.2/g' manifest.yaml

# 使用 PowerShell (Windows)
(Get-Content manifest.yaml) -replace 'version: 0.0.1', 'version: 0.0.2' | Set-Content manifest.yaml
```

### 2. 生成变更日志
```bash
git log --oneline --since="1 week ago" > CHANGELOG.md
```

### 3. 打包发布
```bash
# 创建发布包
zip -r halo-blog-tools-v0.0.1.zip . -x "*.git*" "*__pycache__*" "*.env" "key.txt"
```

## 🧪 测试命令

### 1. 单元测试
```bash
python -m pytest tests/ -v
```

### 2. 集成测试
```bash
python test_integration.py
```

### 3. 性能测试
```bash
python -m cProfile -o profile.stats main.py
```

## 📝 日志分析命令

### 1. 提取错误日志
```bash
grep "ERROR" *.log | tail -20
```

### 2. 统计请求类型
```bash
grep -o "POST\|GET\|PUT\|DELETE" *.log | sort | uniq -c
```

### 3. 分析响应时间
```bash
grep "Request took" *.log | awk '{print $NF}' | sort -n
```

## 🔐 安全检查命令

### 1. 检查敏感信息
```bash
grep -r "password\|token\|secret" . --exclude-dir=.git
```

### 2. 验证 HTTPS
```bash
curl -I -s https://your-halo-site.com | grep -i "strict-transport-security"
```

### 3. 检查依赖漏洞
```bash
pip audit
```

## 🚨 紧急修复命令

### 1. 回滚到上一版本
```bash
git checkout HEAD~1 -- .
```

### 2. 强制重置
```bash
git reset --hard HEAD
git clean -fd
```

### 3. 紧急停止服务
```bash
# 查找进程
ps aux | grep python
# 强制终止
kill -9 <PID>
```

## 📋 检查清单

### 部署前检查
- [ ] 版本号已更新
- [ ] 依赖已安装
- [ ] 配置文件正确
- [ ] 测试通过
- [ ] 文档已更新

### 问题排查清单
- [ ] 检查网络连接
- [ ] 验证访问令牌
- [ ] 确认权限设置
- [ ] 查看错误日志
- [ ] 测试API端点
